name: Semantic Release (Python/UV)

on:
  workflow_call:
    inputs:
      python-version:
        description: "Python version"
        required: false
        default: "3.13"
        type: string
      runner:
        description: "GitHub Actions runner"
        required: false
        default: "blacksmith-4vcpu-ubuntu-2404"
        type: string
      pypi-publish:
        description: "PyPI publish mode: 'true' for PyPI, 'test' for TestPyPI, 'false' to skip"
        required: false
        default: "false"
        type: string

jobs:
  release:
    name: Release
    runs-on: ${{ inputs.runner }}
    concurrency: release
    permissions:
      contents: write
      id-token: write
    environment:
      name: pypi

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup uv and Python
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ inputs.python-version }}
          enable-cache: true

      - name: Install dependencies
        run: uv sync --group maintain

      - name: Semantic Release
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set +e
          output=$(uv run semantic-release version --changelog --push --tag --vcs-release 2>&1)
          exit_code=$?
          set -e
          echo "$output"
          if echo "$output" | grep -q "No release will be made"; then
            echo "released=false" >> "$GITHUB_OUTPUT"
          elif [ $exit_code -ne 0 ]; then
            echo "Semantic release failed with exit code $exit_code"
            exit $exit_code
          else
            echo "released=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Build package
        if: steps.release.outputs.released == 'true'
        run: uv build

      - name: Publish to TestPyPI
        if: steps.release.outputs.released == 'true' && inputs.pypi-publish == 'test'
        run: uv publish --publish-url https://test.pypi.org/legacy/

      - name: Publish to PyPI
        if: steps.release.outputs.released == 'true' && inputs.pypi-publish == 'true'
        run: uv publish
